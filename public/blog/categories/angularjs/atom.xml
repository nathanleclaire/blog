<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: angularjs | nathan leclaire]]></title>
  <link href="http://nathanleclaire.com/blog/categories/angularjs/atom.xml" rel="self"/>
  <link href="http://nathanleclaire.com/"/>
  <updated>2014-09-29T03:20:27+00:00</updated>
  <id>http://nathanleclaire.com/</id>
  <author>
    <name><![CDATA[Nathan LeClaire]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[5 AngularJS Antipatterns & Pitfalls]]></title>
    <link href="http://nathanleclaire.com/blog/2014/04/19/5-angularjs-antipatterns-and-pitfalls/"/>
    <updated>2014-04-19T13:58:00+00:00</updated>
    <id>http://nathanleclaire.com/blog/2014/04/19/5-angularjs-antipatterns-and-pitfalls</id>
    <content type="html"><![CDATA[<h1>The Angular Jungle</h1>

<p><img src="/images/angular-antipatterns/jungle.jpg"></p>

<p><a href="http://angularjs.org">AngularJS</a> is a big JavaScript framework and it gives you just enough rope to hang yourself with.  I&#8217;ve written a lot about it in this blog and really hope that I have made a noteworthy impact on improving the general availability of resources.  I&#8217;ve been working on a project using AngularJS at my dayjob lately and noticed some antipatterns and pitfalls that people fall into when they are new to Angular (myself included, so they&#8217;re based on my own sweat and blood learning the framework) and I&#8217;ve consolidated some of them here for you to peruse.  Hopefully I&#8217;ll save you some pain.</p>

<p>They are:</p>

<ol>
<li>Not having a dot in your <code>ng-model</code> (or other places you need it!)</li>
<li>Extreme overuse of event broadcasting and listening (<code>$emit</code>, <code>$broadcast</code>, <code>$on</code>)</li>
<li>Too much stuff in controllers</li>
<li>Misunderstanding or misusing isolate scope</li>
<li>Using the outside world instead of doing things the Angular way</li>
</ol>


<h1>1. Not having a dot in your <code>ng-model</code> (or other places you need it!)</h1>

<p><img src="/images/angular-antipatterns/george.jpg"></p>

<p>Angular&#8217;s <a href="https://docs.angularjs.org/guide/directive">directives</a> provide fantastic flexibility and an amazing way to write HTML that describes its interactive behavior in a clean and clear fashion.  They provide a way to create <a href="https://egghead.io/lessons/angularjs-understanding-isolate-scope">isolate scope</a> to promote reusability and creating a directive that uses this looks something like:</p>

<pre><code class="js">angular.module('myApp').directive('myDir', function () {
  return  {
    restrict: 'E',
    scope: {
      aProperty: '=',
      bProperty: '&amp;'
    },
    // and so on...
  };
});
</code></pre>

<p>In the above definition <code>aProperty</code> gets passed in through an attribute (normalized to <code>a-property</code>) and creates a two-way data binding between the parent scope and the child scope.  That means if you change one, the other will be updated to match it and vice versa.  However, because of the way that JavaScript&#8217;s prototypal inheritance works, sometimes this may not work &#8220;magically&#8221; as you would expect.  I will dicuss a particular situation with <code>ng-model</code> here but know that understanding how this all ties together will save you lots of tears due to <code>ng-switch</code>, <code>ng-repeat</code>, etc. creating their own scopes (and &#8220;shadow&#8221; properties in the prototype chain) that throw off the way you might be expecting things to work.</p>

<p>In particular, when you have an <code>ng-model</code> bound to a property on <code>$scope</code> which was originally passed in using <code>=</code> in your child directive:</p>

<blockquote><p>“Whenever you have ng-model there’s gotta be a dot in there somewhere. If you don’t have a dot, you’re doing it wrong.”</p></blockquote>

<p>Words from the mouth of Miško himself.</p>

<p>This is because <em>primitives</em> (String, Number, etc.) passed in to a child scope create their own &#8220;shadow&#8221; property in the child scope, which hides the original property on the parent scope due to the way that JavaScript prototypes work (the prototype chain will not need to be consulted to determine the value of <code>foo</code> if <code>foo</code> is not an <code>Object</code> or <code>Array</code>).  If they are bound using <code>=</code> and they are objects, however, <code>foo.bar</code> <em>will</em> be bound correctly to the original property in the parent scope.</p>

<p>Understanding this will save you soooo much pain.  Seriously, if you&#8217;re serious about Angular at all, take the time to read the offical article I link at the end of this section.  Then read it again.</p>

<p>I suspect that a misunderstanding of this (communicating effectively from scope to scope up and down the prototype chain) is at least partially what contributes to people digging themselves further and further into a hole by misusing event broadcasting/emitting/listening and isoalte scope, as detailed later on in this article.  When things spiral out of control in this manner, it can really be pure torture.  You&#8217;re fighting against the framework, and nobody wins in that battle, least of all the people who have to maintain your code.</p>

<p>The point is, most people new to Angular (and even people who have been doing it for a while) expect this to work :</p>

<p>
&#8220;`</p>

<p> You have {{dollars}} dollars </p>


<p><crazy-awesome-widget ng-repeat="account in accounts" info="dollars">
</crazy-awesome-widget></p>

<script>
angular.module('dotDemo').controller('OuterCtrl', function($scope) {
  $scope.dollars = 5;
  $scope.accounts = ["Tom", "Bobby", "Sally"];
});
angular.module('dotDemo').directive('crazyAwesomeWidget', function() {
  return {
    restrict: 'E',
    template: '<input type="text" ng-model="info" />',
    scope: {
      info: '='
    }
  };
});
</script>


<p>&#8220;`
</p>

<p>Can you spot the bug?  If you&#8217;ve been paying attention, you should be able to pick it out easily.</p>

<iframe src="http://embed.plnkr.co/ii8xZoOIRcWw4LlNMayf/preview"></iframe>


<p>Come on, intone it with me.  <em>I need a dot. I need a dot. I need a dot.</em></p>

<p>In the above code the input boxes won&#8217;t update the property in the parent scope.  The prototype chain creates a new property <code>info</code> which is unique to the child scope instead of bound to the parent scope.  It won&#8217;t work this way.  You need an object.  The code should look like this instead:</p>

<p>
&#8220;`</p>

<p> You have {{customerData.dollars}} dollars </p>


<p><crazy-awesome-widget ng-repeat="account in accounts" info="customerData">
</crazy-awesome-widget></p>

<script>
angular.module('dotDemo').controller('OuterCtrl', function($scope) {
  $scope.customerData = {
    dollars: 5
  };
  $scope.accounts = ["Tom", "Bobby", "Sally"];
});
angular.module('dotDemo').directive('crazyAwesomeWidget', function() {
  return {
    restrict: 'E',
    template: '<input type="text" ng-model="info.dollars" />',
    scope: {
      info: '='
    }
  };
});
</script>


<p>&#8220;`
</p>

<iframe src="http://embed.plnkr.co/IVkqcNVhwQXd1zQ9nZQ2/preview"></iframe>


<p>Boom, synchronization from parent scope => isolated child scopes and back again.</p>

<p>Big shout out to Reddit user <a href="http://www.reddit.com/user/Commentares">Commentares</a> who caught a flaw in the original implementation of my first example in the first draft of this article.</p>

<p>See for reference:</p>

<ul>
<li><a href="http://jimhoskins.com/2012/12/14/nested-scopes-in-angularjs.html">This excellent article by Jim Hoskins</a></li>
<li><a href="https://github.com/angular/angular.js/wiki/Understanding-Scopes">This aforementioned Angular documentation gettin&#8217; mad deep about scopes</a></li>
</ul>


<h1>2. Extreme overuse of event broadcasting and listening (<code>$emit</code>, <code>$broadcast</code>, <code>$on</code>)</h1>

<p>Everybody loves to hate on GOTOs.  Poor little GOTOs.  All they ever wanted to do was help control program execution flow and branching, and they get the Rodney Dangerfield treatment.  They&#8217;re reviled with that sort of knee-jerk reaction that only programmers can revile something with.  You know the type.  They&#8217;re the ones who got burned by <code>git rebase</code> one time (it was their own fault) and spend way too much effort and energy spreading FUD about rebases.  But I digress.  My point is, there&#8217;s this Angular antipattern I&#8217;ve seen and fallen into, where <code>$scope.$emit</code> and <code>$scope.$broadcast</code> have become the new GOTO.  Except that it&#8217;s shiny and new and Angular-ey, so everybody gives it a pass.  <code>$scope.$watch</code> can kind of be abused in the same way, but the others are slightly easier to pick on.</p>

<p>I really feel that you should keep manual event broadcasting and catching out of your code if possible.  It doesn&#8217;t usually do a whole lot of good and confuses the hell out of the people who have to maintain your code (including you!).  The problem is thus:  Let&#8217;s say you have something going wacky in a <code>$scope.$on</code>.  You set a breakpoint in the defined callback function that runs when that <code>$scope.$on</code> catches its defined event.  OK, now what?  Perhaps you look to see where the event was thrown from.  With constrained eventing, debugging shouldn&#8217;t be a problem, but if you or your team lets their discipline slip into event spaghetti you&#8217;re in for a world of pain.  Usually this can be avoided by careful use of services and proper scope inheritance.</p>

<h1>3. Too much stuff in controllers</h1>

<p>It&#8217;s unfortunate that I have to point this one out, but as I&#8217;ve personally fallen into this pitfall especially when first getting started with Angular, I suppose I can give people a free pass on making this mistake once or twice.  After that, however, they should definitely learn.</p>

<p>Your controllers should be lean.  Say it with me.</p>

<p>My controllers should be lean.</p>

<p>My controllers should be lean.</p>

<p>My controllers <em>are</em> lean.</p>

<p>This means that absolutely everything which can be stripped out of them, should be.  They exist to coordinate the delicate dance between your other resources (services and directives).</p>

<p>For instance, I came across a line introduced in one of our controllers that looked like this:</p>

<pre><code>$('body').attr('data-state', 'someNewState');
</code></pre>

<p>This was my reaction upon finding this code in this controller:</p>

<p><img src="/images/angular-antipatterns/hulk.gif"></p>

<p>Note:  My actual reaction was way more passive aggressive (wrote about it in my <em>blog</em>!  Showed that guy).</p>

<p>In Angular, DOM manipulation is done inside directives.  NOT controllers.  DOM manipulation is done inside directives.  Every aspiring Angular programmer should have this branded into his or her brain.</p>

<p>Other common things that slip into controllers:</p>

<ul>
<li>Ajax (sometimes disguised in a half-baked abstraction) - this should be done in services</li>
<li>Tangled mess of event handling as discussed in last section</li>
<li>Things that are basically service or factory logic, but eh I&#8217;m too lazy to move this code</li>
</ul>


<p>Don&#8217;t do it.  If you keep your controllers lean and small they will reward you with readability and ease of debugging.  If you let them spiral out of control you will be punished unceremoniously.</p>

<h1>4. Misunderstanding or misusing isolate scope</h1>

<p>Isolate scope is really nice.  It prevents directives from just accessing / modifying the parent scope willy-nilly, opening the door to all kinds of bugs associated with global-ish scope, and promotes reusability.  But it&#8217;s important to realize that this is the point of isolate scope.  Consequently, if you&#8217;re passing a bunch of properties into your directive&#8217;s <code>$scope</code>, and then cascading them downwards through a variety of child scopes, you are probably doing something wrong.</p>

<p>I&#8217;ve seen this a bit.  If you are passing a bunch of information down to your directive&#8217;s scope, either it should be inheriting by default (in which case you don&#8217;t want isolate scope), or you should bundle the properties that you can together in an object or two to keep the <code>scope</code> definition nice and clean and promote readability of the HTML.</p>

<h1>5. Using the outside world instead of doing things the Angular way</h1>

<p><img src="/images/angular-antipatterns/but-computers.png" title="Aren&#8217;t we all nowadays?" ></p>

<p>It&#8217;s really tempting, especially when first learning Angular, and directives in particular, to just write jQuery code like we always have that happens to be wrapped in an Angular directive.  While this is still probably better than rolling with no framework at all and creating a tangled mess, it indicates a basic ungrok of the Angular way.</p>

<p>Things should be done in Angular, when they can.  Angular provides so much niceness in the form of built-in directives, services (<code>$window</code>, <code>$timeout</code>, <code>$http</code> et al. wrap these things for you so you don&#8217;t have to worry about accidentally interfering with Angular&#8217;s internals!) that we should only reach for custom solutions when we have to (and believe me, you will - just think carefully before doing so).  Just wrapping jQuery code in a directive doesn&#8217;t do us any good, and creates complications when we need to start doing stuff like chucking <code>$scope.$apply</code> into things.  So think things through, and do them the Angular way.</p>

<p>Likewise dependencies that you had before (modules you are relying on etc.) should be refactored into e.g. factories for increased ease of use and testability.  If you have the time to use Angular into your project, you have the time to do this too.  Angular will reward you with layers of increased richness.</p>

<h1>Fin</h1>

<p>I really hope that this article helps people avoid these bad behaviors, or at least see them when they come across them and refactor them into something better.</p>

<p>Until next time, stay sassy Internet.  And <a href="http://nathanleclaire.com">consider subscribing to my mailing list</a>.</p>

<ul>
<li>Nate</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Unit Testing Services in AngularJS for Fun and for Profit]]></title>
    <link href="http://nathanleclaire.com/blog/2014/04/12/unit-testing-services-in-angularjs-for-fun-and-for-profit/"/>
    <updated>2014-04-12T23:14:00+00:00</updated>
    <id>http://nathanleclaire.com/blog/2014/04/12/unit-testing-services-in-angularjs-for-fun-and-for-profit</id>
    <content type="html"><![CDATA[<p><img src="/images/unit-test-angularjs-service/jasmine.png" title="Your new best friend." ></p>

<p>If there was a way to reduce the number of defects in the code you write (or manage), improve the quality and time to market of deliverables, and make things easier to maintain for those who come after you- would you do it?</p>

<p>Right about now, especially given the content of the article, you might be sensing that I&#8217;m about to jump into the usual testing zealot rant.  And you&#8217;re right.</p>

<p>How many times have you heard some variant on, &#8220;Writing tests isn&#8217;t as important as delivering finished code?&#8221;  If you&#8217;re like me, it&#8217;s way too many, and god help you if you&#8217;re working with no tests at all.  Programmers are human and we all make mistakes.  So test your code.  The number of times testing my code has helped me catch unforeseen issues before they became flat-out bugs, prevent future regressions, or simply architect better is pretty amazing.  And this is coming from a guy who used to hate writing tests for code.  <em>Hated</em> it.</p>

<p>I think that stemmed more from a lack of understanding how to do it than anything else.  When systems get complex and have a lot of moving parts is when it is most critical to test them, and that is also when it becomes the most difficult to test them.  Without an understanding of your tools (e.g. mocks) or why each piece is important, and especially with a lack of easily accessible examples, testing code can be really intimidating and frustrating.</p>

<p>So what do you do?  You commit code without tests.  You are cowboy.  Cowboy no test.</p>

<p><img src="/images/unit-test-angularjs-service/cowboy.png"></p>

<p>But as some of you probably know all too well, this is dangerous.  It&#8217;s like going on vacation in the Caribbean using your credit card.  Fun for a while, and everything seems great, until suddenly reality hits and <a href="http://en.wikipedia.org/wiki/Red_Queen's_race">it takes all the running you can do just to stay in the same place</a>.</p>

<p>Fortunately Angular treats us really well as far as testing goes.  It just requires some additional explanation, since the quality of resources available for both Angular <em>and</em> Jasmine is really not fantastic.  It&#8217;s better than a year ago, definitely, but not fantastic.</p>

<p>So here I am doing a brain dump of sorts of what I know about testing services, which are part of the <a href="http://nathanleclaire.com/blog/2014/03/15/angularjs-isnt-mvc-its-sdc/">lifeblood</a> of any Angular application.</p>

<h1>Section 1: In Which I Proclaim &#8220;I love Dependency Injection!&#8221;</h1>

<p>When I first saw someone present on Angular, they got kind of hand-wavey about <a href="http://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>.  &#8220;The way I see it, it&#8217;s basically magic and I don&#8217;t have to think about it.&#8221;  Ahhh.  Not what I like to hear.</p>

<p>I get that it can be kind of scary, hearing people throw around jargon like injectors and providers and dependency injection like they&#8217;re nothing, but you can get it.  I know you can.</p>

<p>It&#8217;s simple.  Not easy, but simple.  When Angular runs the code that you define for a controller or a service, it looks at the parameters you have attached to the function and sets them correctly for that run based on their names.  Let&#8217;s say that you have something like this:</p>

<pre><code class="js">angular.module("foo").controller("NavCtrl", function ($scope, tabService) {
  // ...
});
</code></pre>

<p>The order of the parameters on your function doesn&#8217;t matter.  You could just as easily have said <code>function (tabService, $scope)</code> and both of those values would still be set correctly.  That&#8217;s a nice advantage in itself, and it&#8217;s why you see funny business like:</p>

<pre><code class="js">angular.module("foo").controller("NavCtrl", [
  "$scope",
  "tabService",
  function($scope, tabService) {
    // ...
  }
]);
</code></pre>

<p>That&#8217;s so that <a href="http://en.wikipedia.org/wiki/Minification_%28programming%29">minification</a>, which renames all of your passed variables in functions, doesn&#8217;t blow up Angular&#8217;s dependency injection.  Angular knows how to handle this if you use the second form of notation.</p>

<p>But why are we even messing with this at all?  It&#8217;s because if we inject the dependencies, we can control them from the outside world.  And this is eminently important for testing.</p>

<p>This kind of thing (admittedly contrived for effect):</p>

<pre><code class="js">function mungeSomeData(data) {
  var dataGetter, dataParser, dataTransformer;
  dataGetter = new DataGetter();
  dataParser = new DataParser();
  dataTransformer = data.isXML() ? new XMLDataTransformer() : new JSONDataTransformer();
  // ...
}
</code></pre>

<p>Doesn&#8217;t use Depdency Injection, and is a nightmare to test.  Minimizing surface area to test is so so important, and by writing code that way you make your surface area HUGE and slippery.</p>

<p>Side note:  It is Angular convention to have a dollar sign (<code>$</code>) in the front of the names of things that are both injected (<code>$scope</code>, <code>$timeout</code>, <code>$http</code>) and built-in to Angular.  If you see <code>$scope</code> being used in the link function of a directive, that is both wrong and confusing since parameters are <em>passed</em> to the link function of directives, not injected.  Please Hulk out when you see this and correct the code.  If you are using <code>vim</code> a simple <code>:%s/$scope/scope/</code> (or perhaps just <code>:s</code> in visual mode if you have instances of <code>$scope</code> that <em>shouldn&#8217;t</em> be replaced) will do the trick.</p>

<p><strong>Q: So what does that have to do with unit testing AngularJS services, Nate?</strong></p>

<p>It has everything to do with testing services since they are injected.  So, in unit testing a service, you can control precisely what goes on in one in addition to all of its dependencies.</p>

<p><strong>Q: Will you show us some actual Jasmine code already?</strong></p>

<p>Getting there.</p>

<h1>Section 2: In Which I Write an Actual Service, and a Unit Test for It</h1>

<p>Let&#8217;s say that I&#8217;m writing an Angular app which interacts with the Reddit API.  Since we know that services are the part which Angular uses to interact with the outside world, we will write a service to handle our needs.</p>

<p>We are going to write one with a method <code>getSubredditsSubmittedToBy(user)</code> which returns a list of which subreddits a user has submitted to recently.  We can use <a href="https://egghead.io/lessons/angularjs-chained-promises">promise chaining</a> to achieve this (aggregating the big glob of JSON returned by the API call) so that our controller stays super lean.</p>

<h2>Writing the Service</h2>

<p>Usage (inside controller):</p>

<pre><code>userService.getSubredditsSubmittedToBy("yoitsnate").then(function(subreddits) {
  $scope.subreddits = subreddits;
});
</code></pre>

<p>So nice and readable!</p>

<p>Our service looks like this:</p>

<pre><code class="js">angular.module("reddit").service("userService",
function($http) {
  return {
    getSubredditsSubmittedToBy: function(user) {
      return $http.get("http://api.reddit.com/user/" + user + "/submitted.json").then(function(response) {
        var posts, subreddits;

        posts = response.data.data.children;

        // transform data to be only subreddit strings
        subreddits = posts.map(function(post) {
          return post.data.subreddit;
        });

        // de-dupe
        subreddits = subreddits.filter(function(element, position) {
          return subreddits.indexOf(element) === position;
        });

        return subreddits;
      });
    }
  };
});
</code></pre>

<h2>Writing the test</h2>

<p>We will write a test using <a href="http://pivotal.github.io/jasmine/">Jasmine</a>.  Jasmine is a Behavior-Driven-Development framework, which is sort of a roundabout way of saying that our tests include descriptions of the sections that they are testing and what they are supposed to do.  This is done using nested <code>describe</code> and <code>it</code> blocks, which look really weird at first (something about a function as short as <code>it</code> is just unsettling to me ;) ) but can be helpful in understanding what the test is intended to, well, test.</p>

<p>This is quite helpful as sometimes large elaborate codebases have large elaborate tests and it can be hard to figure out what&#8217;s what.  For instance, in PHPUnit, this kind of &#8220;built-in documentation&#8221; is spread out and mostly optional, and makes complex unit tests a bit trickier to read.</p>

<p>Using Karma we first tell it what module we&#8217;re working in (<code>"reddit"</code>), run an inject function to set up our dependencies and get the service under test (this allows us access to Angular&#8217;s injector so we can set local test variables), then run an actual test in the <code>it</code> block.</p>

<p>Notice that in the <code>inject</code> method we inject in <code>_foo_</code>, with an underscore on either side of the name of the actual service, so that we can set it in the outer <code>describe</code> closure.  This is by design, as the Angular maintainers foresaw (or discovered) that:</p>

<pre><code>var redditService;
beforeEach(inject(redditService) {
  redditService = redditService;
});
</code></pre>

<p>would result in an error.</p>

<p>So use <code>_underscoreNotation_</code> to get the service that you want to test :)</p>

<pre><code>"use strict";

describe("reddit api service", function () {
  var redditService, httpBackend;

  beforeEach(module("reddit"));

  beforeEach(inject(function (_redditService_, $httpBackend) {
    redditService = _redditService_;
    httpBackend = $httpBackend;
  }));

  it("should do something", function () {
    httpBackend.whenGET("http://api.reddit.com/user/yoitsnate/submitted.json").respond({
        data: {
          children: [
            {
              data: {
                subreddit: "golang"
              }
            },
            {
              data: {
                subreddit: "javascript"
              }
            },
            {
              data: {
                subreddit: "golang"
              }
            },
            {
              data: {
                subreddit: "javascript"
              }
            }
          ]
        }
    });
    redditService.getSubredditsSubmittedToBy("yoitsnate").then(function(subreddits) {
      expect(subreddits).toEqual(["golang", "javascript"]);
    });
    httpBackend.flush();
  });

});
</code></pre>

<p>Our mock data here mimics the actual data returned by the Reddit API, but only enough that we get the necessary bits of structure in place and can account for, say, the duplicate case.  If we wanted to add different functionality for different pieces of the API, or of this call, we could just define new <code>httpBackend</code> responses in new <code>it</code> blocks and test things the same way without having to worry about the bits of the API response we don&#8217;t need.</p>

<h2>The provider idiom</h2>

<p>Unfortunately my simple example above breaks down a little bit if we have additional dependencies on other services in our service under test.  What do we do in this case?  We need to control these injected parameters, and to do so we use <code>$provide</code>.  <code>$provide</code> can take the name of e.g. a service and dictate what to provide for it.  In doing so we can, say, use a spy object instead of the &#8220;real deal&#8221;.</p>

<pre><code>beforeEach(module(function($provide) {
  $provide.value("myDependentService", serviceThatsActuallyASpyObject);
}));
</code></pre>

<p>Note that <code>$provide</code> should always be called before your call to <code>$inject</code>, since the former dicates what the latter should use.</p>

<h1>Section 3: Helpful Tips</h1>

<h2>Stutter.</h2>

<p>If you change a <code>describe</code> or <code>it</code> block to <code>ddescribe</code> or <code>iit</code> respectively <a href="http://karma-runner.github.io/0.12/index.html">Karma</a> (<a href="http://nathanleclaire.com/blog/2013/12/13/how-to-unit-test-controllers-in-angularjs-without-setting-your-hair-on-fire/">Angular&#8217;s test runner</a>) will run only that block.  This is called <a href="https://github.com/davemo/jasmine-only">stuttering</a> and it is very useful if you don&#8217;t want to run your entire test suite every time, as the larger the codebase gets the longer this will take to do.</p>

<h2>Don&#8217;t be afraid to rearrange code that is hard to test</h2>

<p>If you can move code around to make it easier to test without changing other things, DO IT (in a general sense I find that this eases readability and maintainability too).  For instance I found that in one instance in a service a colleague was relying on a function call that was both unneccesary and confusing, and ultimately broke the chain of promises.  So I deleted the function definition and inlined the code it contained.  The resulting code was a bit easier to read and test.</p>

<h2>Cheat.</h2>

<p>You can create stubbed objects quite easily in JavaScript, so if there&#8217;s no need to introduce the extra complexity of a spy (see next section), then do so.  For example, if you can just return <code>4</code> from a method every time you call it instead of counting the elements or whatever it usually does, then do so.</p>

<h2>Do you need a Spy?</h2>

<p>If you need more power / assertions out of the last point, Jasmine provides Spies for you to use.</p>

<p>They&#8217;re a little out of scope for this article, but they should provide you all of the flexibility you need for faking data / objects / calls and testing what was faked.</p>

<p>For a good reference, see this <a href="http://tobyho.com/2011/12/15/jasmine-spy-cheatsheet/">Jasmine spy cheatsheet</a>.</p>

<h2>Or just use <code>$q</code> / manually manage promises</h2>

<p>I found myself in kind of a funny situation at work recently.  We use Angular for structure but the codebase we are working on has a lot of pre-existing bits/modules that were not really moved over to Angular fully due to intense deadline pressure.  So, we find ourselves making XMLHttpRequests outside of <code>$http</code> land, but the original programmers still return promises from their outside world modules for us to use (it&#8217;s kind of an odd setup that we don&#8217;t really have time to refactor).  So, I just caused the functions that take care of those API calls return promises that I control using <code>$q</code>.</p>

<pre><code class="js">var mockPromise;
mockDeferred = $q.defer();
someSpyObj.methodThatReturnsAPromise.andCallFake(function () {
  return mockDeferred.promise;
});
mockDeferred.resolve({
  things: "foo",
  otherThings: "bar"
});
</code></pre>

<h1>Conclusion.</h1>

<p>Jasmine tests are pretty quick to write once you get the hang of them.  Seriously guys, there&#8217;s no excuse.</p>

<p>The <a href="http://blog.codinghorror.com/coding-for-violent-psychopaths/">violent psychopath who ends up maintaining your code</a> will thank you.  Or at least not murder you.</p>

<p>Until next time, stay sassy Internet, and <a href="http://nathanleclaire.com">consider subscribing to my blog</a>.</p>

<ul>
<li>Nathan</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Banging Your Head Against an AngularJS Issue?  Try This]]></title>
    <link href="http://nathanleclaire.com/blog/2014/01/31/banging-your-head-against-an-angularjs-issue-try-this/"/>
    <updated>2014-01-31T19:53:00+00:00</updated>
    <id>http://nathanleclaire.com/blog/2014/01/31/banging-your-head-against-an-angularjs-issue-try-this</id>
    <content type="html"><![CDATA[<p><img src="/images/scope-apply/frustration.jpg" title="Have you been debugging something that seems trivial in Angular for so long that your face looks like this?" ></p>

<p>As I&#8217;ve gotten a <a href="http://nathanleclaire.com/blog/2014/01/04/5-smooth-angularjs-application-tips/">little</a> <a href="http://nathanleclaire.com/blog/2014/01/11/dragging-and-dropping-images-from-one-browser-tab-to-another-in-angularjs/">into</a> <a href="http://angularjs.org">AngularJS</a> I&#8217;ve been surprised by how often my assumptions about how things will work have turned out to be wrong.  When you start to form a basic mental model of how Angular works and you hit your first stumbling block where your model turns out to be incorrect it can be really, really, frustrating.  In particular I had one issue that kept cropping up so often I began trying it before running to Google for help if something wasn&#8217;t working the way I would have expected (all my views should just magically sync up with what&#8217;s on <code>$scope</code>, right?).  This solution is to make sure <code>$scope.$apply</code> is getting used in the proper manner when updates to <code>$scope</code> are happening, especially if they are happening in unusual places e.g. inside of directives.  Since I don&#8217;t really like &#8220;magical&#8221; or knee-jerk fixes to problems I highly recommend Jim Hoskins&#8217;s article on <code>$scope.$apply</code> which you can find <a href="http://jimhoskins.com/2012/12/17/angularjs-and-apply.html">here</a>.</p>

<h1>Use <code>$scope.$apply</code></h1>

<p>During your first foray into Angular you will probably not come across this as it is one of those hidden, quasi-leaky-abstraction sort of things that only becomes well known to you as you work on getting a non-trivial app off the ground.  After all, it&#8217;s not really needed for the <a href="http://todomvc.com/architecture-examples/angularjs/#/">todo-list app</a> of yore but it becomes much more important when you are doing funny things like manipulating scope deep inside of directives and so on.  So, having been bit by the issue multiple times, I recommend trying a call to <code>$scope.$apply</code> (either wrap the changes to <code>$scope</code> properties inside a <code>$scope.apply</code> callback, or call <code>$scope.$apply</code> on its own after <code>$scope</code> properties have been updated)  See the documentation <a href="http://nathanleclaire.com/blog/2014/01/04/5-smooth-angularjs-application-tips/">here</a>.</p>

<p>The issue is around updating properties on <code>$scope</code>, either in directives or in controllers, and not having the updated changes be reflected on the front-end in the manner which you expect (either they will not show up at all, or they will happen in an order which you do not anticipate, which will cause bugs).  This is because Angular has what is known as a digest-watch cycle where all of this gets figured out:</p>

<p><img src="/images/scope-apply/digest-cycle.png"></p>

<p>As automagical as Angular is in some ways, it has no way of knowing when your property has been updated outside of Angular-land (and sometimes doesn&#8217;t even bother when it is updated <em>in</em> Angular-land, as per the example that follows).  So it requires a call to <code>$scope.$apply</code> to stay in sync.</p>

<h1>Example</h1>

<p>Let&#8217;s say you have a list of numbers displayed with <code>ng-repeat</code> and you want to <code>shift</code> one off the list when the user presses the right arrow key, and redisplay them one at a time if the user presses the left arrow key.  Our controller code (on first attempt) would look something like this:</p>

<pre><code class="js">.controller('NumCtrl', function($scope) {
    var history = [];
    $scope.numbersDisplayed = [0,1,2,3,4,5];

    $scope.moveRight = function() {
        history.unshift($scope.numbersDisplayed.shift());
    };

    $scope.moveLeft = function() {
        $scope.numbersDisplayed.unshift(history.shift());
    };
})
</code></pre>

<p>We&#8217;re ignoring bounds-checking for the sake of simplicity in this demonstation.  Our directive, designated to watch for user input on the element where this is happening (will be <code>&lt;body&gt;</code> in our case since it is a simple little example), will look like this:</p>

<pre><code class="js">.directive('arrowListener', function() {
    return {
        restrict: 'A', // attribute
        scope: {
            moveRight: '&amp;', // bind to parent method
            moveLeft: '&amp;'
        },
        link: function(scope, elm, attrs) {
            elm.bind('keydown', function(e) {
                if (e.keyCode === 39) {
                    scope.moveRight();
                }
                if (e.keyCode === 37) {
                    scope.moveLeft();
                }
            })
        }
    };
})
</code></pre>

<p>If you try the above code, you&#8217;ll notice that it doesn&#8217;t work.  The variable on <code>$scope</code> gets changed correctly, but this change is not reflected in the view.  In order to make it work you have to change the controller code to :</p>

<pre><code class="js">.controller('NumCtrl', function($scope) {
    var history = [];
    $scope.numbersDisplayed = [0,1,2,3,4,5];

    $scope.moveRight = function() {
        history.unshift($scope.numbersDisplayed.shift());
        $scope.$apply();
    };

    $scope.moveLeft = function() {
        $scope.numbersDisplayed.unshift(history.shift());
        $scope.$apply();
    };
})
</code></pre>

<p>You could also invoke <code>scope.$apply</code> in the directive itself.  To be honest, I&#8217;m not sure what the Angular gurus would consider best practice.  Perhaps the latter since it is more DRY.</p>

<p><em>EDIT</em>: I have received an email from a reader, Andrew Greenberg, that indicates the latter is indeed the way to go.  In fact, he points out a deeper flaw in my reasoning/approach:</p>

<blockquote><p>[There&#8217;s a problem with your code] &#8230; that can be the cause of significant bugs down the road, because it calls <code>$apply</code> from a scope inside the controller.  This will fail when that function is called from inside an AngularJS <code>$digest</code> cycle, for example, when the functions are called in any expression in the HTML (unless the directive is created in an isolate scope).</p>

<p>As you know, Angular whines hard when <code>$apply</code> is called inside an <code>$apply</code> or <code>$digest</code>.</p>

<p>The better practice is to call <code>$apply</code> only when you know you are outside of a <code>$digest</code> loop, such as inside the directive link function.  That is, keep the <code>$apply</code> out of a <code>$controller</code>, which is accessible to the declarative code in HTML or in another controller — and do the <code>$apply</code> in the directive link function, when you know you are outside of the <code>$digest</code> loop (I think).</p></blockquote>

<p>So there you have it- reasoning why you should call <code>$scope.$apply</code> or <code>$scope.$digest</code> in the link function of your directives, not in your controllers.  My code revised to meet these requirements would look like this:</p>

<pre><code class="js">.directive('arrowListener', function() {
    return {
        restrict: 'A', // attribute
        scope: {
            moveRight: '&amp;', // bind to parent method
            moveLeft: '&amp;'
        },
        link: function(scope, elm, attrs) {
            elm.bind('keydown', function(e) {
                if (e.keyCode === 39) {
                    scope.moveRight();
                }
                if (e.keyCode === 37) {
                    scope.moveLeft();
                }
                scope.$apply();
            })
        }
    };
})
.controller('NumCtrl', function($scope) {
    var history = [];
    $scope.numbersDisplayed = [0,1,2,3,4,5];

    $scope.moveRight = function() {
        history.unshift($scope.numbersDisplayed.shift());
    };

    $scope.moveLeft = function() {
        $scope.numbersDisplayed.unshift(history.shift());
    };
})
</code></pre>

<p>Writing it out, this way looks a bit cleaner to me as well.</p>

<p>A Plunker demo of these concepts in action:</p>

<iframe src="http://embed.plnkr.co/agbSSuA2Mwx5pAd8kZSw/preview"></iframe>


<h1>Conclusion</h1>

<p>This is one of those nasty issues I wish someone would have pointed out to me from the start.  So here you go, guys, hopefully you can get something out of the suffering I&#8217;ve gone through to develop an almost sixth-sense like awareness of when a <code>$scope.$apply</code> will be needed.</p>

<p>Until next week, stay sassy Internet.</p>

<ul>
<li>Nathan</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[4 Smooth AngularJS Application Tips]]></title>
    <link href="http://nathanleclaire.com/blog/2014/01/04/5-smooth-angularjs-application-tips/"/>
    <updated>2014-01-04T14:24:00+00:00</updated>
    <id>http://nathanleclaire.com/blog/2014/01/04/5-smooth-angularjs-application-tips</id>
    <content type="html"><![CDATA[<p>Anyone who follows my blog even a little closely can probably see that I &lt;3 AngularJS:</p>

<ul>
<li><a href="http://nathanleclaire.com/blog/2013/12/13/how-to-unit-test-controllers-in-angularjs-without-setting-your-hair-on-fire/">How to Unit Test Controllers In AngularJS Without Setting Your Hair On Fire</a></li>
<li><a href="http://nathanleclaire.com/blog/2013/12/07/dont-fear-directives-in-angular-dot-js/">Don’t Fear Directives In AngularJS</a></li>
<li><a href="http://nathanleclaire.com/blog/2013/11/30/fear-and-loathing-with-golang-and-angular-dot-js/">Fear and Loathing With Golang and AngularJS</a></li>
</ul>


<p>As I&#8217;ve learned more about the framework, I&#8217;ve come to appreciate many of the design decisions in spite of their initial (beastly) learning curve.  For example, directives provide an absurd amount of flexibility and expressiveness in writing declarative HTML that is unmatched by jQuery-style imperative DOM twiddling.  But the learning curve on them, and other bits of Angular, is weird:</p>

<p><img src="/images/smooth-angular-tips/js-learning-curves.jpeg" title="Hearkens to the Emacs graph of yore." ></p>

<p>Some things that should be pretty straightforward, like navigating from tab to tab in single-page web applications, can be a little confusing to cough up in code <em>100% GUARANTEED TO BE CORRECT &#0153;</em>.  So here&#8217;s a blog article with some cool tips to help you out.</p>

<h1>Highlighting the active tab for the view</h1>

<p>I touched on this a little bit in my unit testing article.  In many applications (single-page ones especially) you&#8217;ll want to assign or get rid of classes on tabs or other navigation features to help the user understand where they&#8217;re navigating to or from (see Bootstrap&#8217;s <code>.active</code> class).  How do we set these conditionally in Angular when we are using partials, and the default routing solution rednering in the <code>ng-view</code> directive?  Simple.  We can use the <code>$location</code> service and declare an <code>ng-class</code> attribute that depends on the result of a simple <code>$scope</code> method.</p>

<p>In the controller:</p>

<pre><code class="js">app.controller('NavCtrl', function($scope, $location) {
    $scope.isActive = function(route) {
        return route === $location.path();
    };
});
</code></pre>

<p>In the view:</p>

<p>&#8220;`</p>

<ul class="nav navbar-nav">
    <li ng-class="{active: isActive('/profile')}">
        <a href="#/profile"><i class="fa fa-dashboard"></i> You</a>
    </li>
    <li ng-class="{active: isActive('/find')}">
        <a href="#/find"><i class="fa fa-bar-chart-o"></i> Find Friends</a>
    </li>
    <li ng-class="{active: isActive('/network')}">
        <a href="#/network"><i class="fa fa-table"></i> Network </a>
    </li>
    <li ng-class="{active: isActive('/chat')}">
        <a href="#/chat"><i class="fa fa-edit"></i> Chat Room </a>
    </li>
</ul>


<p>&#8220;`</p>

<p>Plunker demo of this concept:</p>

<iframe src="http://embed.plnkr.co/Yci9oM/preview"></iframe>


<p>Very useful and IMO, very clean.</p>

<h1>Abstracting business / data providing logic into services</h1>

<p>This is more of an architecture tip than a general solution for common problems, but with my <a href="http://nathanleclaire.com/blog/2013/12/13/how-to-unit-test-controllers-in-angularjs-without-setting-your-hair-on-fire/">recent article on unit testing Angular applications</a> a commenter on Hacker News pointed out that for a variety of reasons I should be putting more of my functions / code that retrieves data to be used in <code>$scope</code> by the controller into services, freeing the controller to just &#8220;glue it all together&#8221; (this also makes mocking things like AJAX calls a lot easier by avoiding <code>$httpBackend</code>).  I hadn&#8217;t really used services very much and all of the talk of factories etc., as well as a general dearth of actual examples in the official documentation on how or why to use them, left me a little bit hesitant to jump right in.  He was kind enough to provide some example code and it made things a bit more lucid for me.  Hopefully the following explanation will help to explain the use case for services as well as provide an illuminating example.</p>

<p>Let&#8217;s say that you want to keep track of some data which multiple controllers can access.  Perhaps it is weather data, preloaded into the page upon load (we&#8217;ll cover using AJAX in this case later in the article) and you need to access it in the user&#8217;s menu bar at the top of the page (to display the current temperature) as well as in a view frame for visualizing complex weather data over time.  We could attempt to jerry-rig together a solution for communicating this from controller to controller using Angular&#8217;s <a href="http://docs.angularjs.org/api/ng.$rootScope.Scope">event system</a> or we could just chuck the aggregate data into <code>$rootScope</code>, but both of those situations are highly awkward from a standpoint of both future and present development.  The solution that Angular provides us for usecases where we need to share (possibly mutable) data between controllers, or interact with things outside of Angular-land (other than the DOM, which is what directives are used for) is to use services.  Services are singleton objects (only instantiated once) that serve as this kind of &#8220;bridge&#8221; or interface from Angular to the outside world or between different parts of your Angular application.  In case you&#8217;re unfamiliar, services are usually created using the <code>factory</code> method on your application module and injected into controllers for use like so:</p>

<pre><code class="js">app.factory('weatherService', function() {
    var weatherData = window.jsObjFromBackend.weather.data;
    return {
        // default to A2 Michigan
        state : 'MI',
        city: 'Ann Arbor',
        getTemperature : function() {
            return weatherData[this.state][this.city].temperature;
        },

        setCity : function(city) {
            this.city = city;
        },

        setState : function(state) {
            this.state = state;
        } 
    };
});
app.controller('MainCtrl', function(weatherService) {
    $scope.temperature = weatherService.getTemperature();   
});
</code></pre>

<p>You can use them in several controllers and they will save you the headache of trying to sync up data over multiple controllers.  They are also a great place to store <code>AWKWARD_CONSTANT_THAT_WOULD_OTHERWISE_BE_GLOBAL</code>.</p>

<h1>Retaining state when switching from view to view</h1>

<p>Services also can save you a potential history headache when navigating from view to view.  If you have some kind of state in one view that you want to be preserved so you can navigate to another view, then back to the original view intact (instead of re-loading the partial which is Angular&#8217;s default behavior), you will find this to be a very handy use case for a service.</p>

<p>For instance, if you wanted to keep track of where a user had scrolled in a <code>&lt;div&gt;</code> element with its <code>overflow</code> propert(y|ies) set to <code>scroll</code>, you could use a combination of a service and a directive to maintain this state.  We will keep track of where the user has scrolled in a service, and coordinate adjusting the element back to that <code>scrollTop</code> state in the <code>link</code> function of the directive (you can inject services into directives much like you inject them into controllers).</p>

<p>Our service is simple:</p>

<pre><code class="js">app.factory('rememberService', function() {
    return {
        scrollTop: undefined
    };
});
</code></pre>

<p>Our directive does a little bit more:</p>

<pre><code class="js">app.directive('scroller', function($timeout, rememberService) {
    return {
        restrict: 'A', // this gets tacked on to an existing &lt;div&gt;
        scope: {},
        link: function(scope, elm, attrs) {
            var raw = elm[0];  // get raw element object to access its scrollTop property

            elm.bind('scroll', function() {
                // remember where we are
                rememberService.scrollTop = raw.scrollTop;
            });

            // Need to wait until the digest cycle is complete to apply this property change to the element.
            $timeout(function() {
                raw.scrollTop = rememberService.scrollTop;
            });
        }
    };
});
</code></pre>

<p>We attach it to the <code>&lt;div&gt;</code> we want to affect like so:</p>

<p>&#8220;`</p>

<div class="scroll-thru-me" scroller>
 <div id="lots-of-stuff">
    &#8230;
 </div>
</div>


<p>&#8220;`</p>

<p>The element will render in the correct <code>scrollTop</code> location.  Obviously this service can be made more complex if neccesary to coordinate maintaining state in a large application.</p>

<p>The following plunker, a modified version of the first plunker on this page, demonstrates the idea.  Try navigating to tab 2, scrolling around a bit, travelling back to view 1 and then back to view 2 yet again.  As you can see, the state of where the user has scrolled to is retained.</p>

<iframe src="http://embed.plnkr.co/3ozt9s/preview"></iframe>


<h1>Making AJAX calls from services</h1>

<p>So what if you want to use Angular&#8217;s <code>$http</code> service to retrieve or set some data on the server, and interact with it from a controller?  We know by now that we should be using services to perform this kind of data-getting, but how do we deal with this asynchrony?  Doing so is not too painful, we simply return the <code>promise</code> Angular gives us when we make an AJAX call, and use the <code>then</code> method to define our callback in the controller.  A simple example:</p>

<pre><code class="js">app.factory('githubService', function($http) {
    var GITHUB_API_ENDPOINT = 'https://api.github.com';
    return {
        getUserInfo: function(username) {
            return $http.get(GITHUB_API_ENDPOINT + '/users/' + username);
        }
    }   
});  

app.controller('MainCtrl', function($scope, githubService) {
    // assuming $scope.username is set with ng-model
    githubService.getUserInfo($scope.username).then(function(data) {
        $scope.userInfo = data;
    });
});
</code></pre>

<p>But what if you want the service to take care of some more stuff (e.g. parsing the response for the desired data) for the controller so they don&#8217;t have to mess with all that business logic?  As an example, note that the response from <code>'https://api.github.com/users/nathanleclaire'</code> returns</p>

<pre><code>{
  "login": "nathanleclaire",
  "id": 1476820,
  "avatar_url": "https://gravatar.com/avatar/3dc6ac660128ff3640413d4036fed744?d=https%3A%2F%2Fidenticons.github.com%2F32974b06cb69bfa6e7331cd4a26dc033.png&amp;r=x",
  "gravatar_id": "3dc6ac660128ff3640413d4036fed744",
  "url": "https://api.github.com/users/nathanleclaire",
  "html_url": "https://github.com/nathanleclaire",
  "followers_url": "https://api.github.com/users/nathanleclaire/followers",
  "following_url": "https://api.github.com/users/nathanleclaire/following{/other_user}",
  "gists_url": "https://api.github.com/users/nathanleclaire/gists{/gist_id}",
  "starred_url": "https://api.github.com/users/nathanleclaire/starred{/owner}{/repo}",
  "subscriptions_url": "https://api.github.com/users/nathanleclaire/subscriptions",
  "organizations_url": "https://api.github.com/users/nathanleclaire/orgs",
  "repos_url": "https://api.github.com/users/nathanleclaire/repos",
  "events_url": "https://api.github.com/users/nathanleclaire/events{/privacy}",
  "received_events_url": "https://api.github.com/users/nathanleclaire/received_events",
  "type": "User",
  "site_admin": false,
  "name": "Nathan LeClaire",
  "company": "Systems In Motion",
  "blog": null,
  "location": "Ann Arbor",
  "email": null,
  "hireable": false,
  "bio": null,
  "public_repos": 18,
  "public_gists": 7,
  "followers": 12,
  "following": 9,
  "created_at": "2012-02-26T23:19:45Z",
  "updated_at": "2014-01-04T23:01:51Z"
}
</code></pre>

<p>There&#8217;s quite a bit of information here, and with more complex API calls response will be full of nested objects and arrays.  What if we just wanted to get the <code>avatar_url</code> with <code>githubService.getUserAvatarUrl(username)</code> and didn&#8217;t care about any of the other stuff?  We can use promise chaining to take care of this logic in the service.  Whatever is returned from the callback on the <code>then</code> method which has been invoked on the result of our <code>$http.get()</code> call (a promise object) will be passed to the callback function on the controller promise&#8217;s <code>then</code> method:</p>

<pre><code class="js">app.factory('githubService', function($http, $q) {
    var GITHUB_API_ENDPOINT = 'https://api.github.com';
    return {
        getUserAvatarUrl: function(username) {
            return $http.get(GITHUB_API_ENDPOINT + '/users/' + username).then(function(res) {
                // Though our return value is simple here, it could easily involve searching/parsing
                // through the response to extract some metadata, higher-order information, etc. that
                // we really shouldn't be parsing in the controller 
                return res.data.avatar_url;
            });
        }
    }   
});

app.controller('MainCtrl', function($scope, githubService) {
    // assuming $scope.username is set with ng-model
    githubService.getUserAvatarUrl($scope.username).then(function(avatarSrc) {
        $scope.avatarSrc = avatarSrc;
    });
});
</code></pre>

<p>Smooth.</p>

<p>Plunkr demo:</p>

<iframe src="http://embed.plnkr.co/e9MHuI/preview"></iframe>


<h1>Conclusion</h1>

<p>That&#8217;s all for now, folks.  Hope you&#8217;ve picked up some useful stuff along the way.  And as always, stay sassy Internet.</p>

<ul>
<li>Nathan</li>
</ul>

]]></content>
  </entry>
  
</feed>
